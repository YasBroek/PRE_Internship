using Revise
using MAPF_code
using Graphs
using SimpleWeightedGraphs
using MultiAgentPathFinding
using Flux
using InferOpt
using Zygote
using Graphs

file_instance = readlines(open("MAPF_code/input/room-32-32-4/instance/room-32-32-4.map"))

instance_data = readlines(
    open("MAPF_code/input/room-32-32-4/instance/room-32-32-4-even-1.scen")
)
instance_type_id = 1
instance_scen_type = "even"
num_agents = 11

instance = MAPF_code.convert_to_my_struct(file_instance, instance_data, num_agents)

features = MAPF_code.extract_features(instance)
@info features
model = Chain(Dense(size(features, 2) => 1), softplus)
opt = Flux.Adam(0.01)
opt_state = Flux.setup(opt, model)

oracle =
    θ -> MAPF_code.path_to_binary_vector(
        instance,
        MAPF_code.independent_shortest_paths(
            MAPF_code.adapt_weights(deepcopy(instance), collect(θ))
        ),
    )
layer = PerturbedMultiplicative(oracle; ε=0.1, nb_samples=5);
@info layer
loss = FenchelYoungLoss(layer);
@info loss
target_solution = MAPF_code.path_to_binary_vector(
    instance,
    MAPF_code.Solution_to_paths(
        Solution(
            BenchmarkScenario(;
                instance="room-32-32-4",
                scen_type=instance_scen_type,
                type_id=instance_type_id,
                agents=num_agents,
            ),
        ),
        instance,
    ),
)

losses = Float64[]
bad_θ = []
bad_target = []

for epoch in 1:100
    x_input = features'

    grads = Zygote.gradient(model) do m
        θ = m(x_input)
        θ_vec = vec(θ')
        println(θ_vec)
        loss(θ_vec, target_solution)
    end

    Flux.update!(opt_state, model, grads[1])

    θ_current = model(x_input)
    θ_vec_current = vec(θ_current')
    println("θ_vec_current: $θ_vec_current, target_solution: $target_solution")
    push!(bad_θ, θ_vec_current)
    push!(bad_target, target_solution)
    current_loss = loss(θ_vec_current, target_solution)
    if epoch % 10 == 0
        println("Epoch: $epoch")
    end
end

@info bad_θ[end]

loss(bad_θ[end], target_solution)

θ_vec_current

loss_val = loss(vec(model(X')'), y_true)

ne(instance.graph)

# Debug the dimensions
println("Features shape: ", size(features))
println("Model input shape: ", size(features'))

# Test the model output
test_output = model(features')
println("Model output shape: ", size(test_output))
println("Model output vec shape: ", size(vec(test_output')))

# Check target solution
println("Target solution shape: ", size(target_solution))
println("Target solution length: ", length(target_solution))

# Check what the oracle expects
# First, let's see what adapt_weights expects
println("Number of edges in instance: ", ne(instance.graph))

# Test oracle with a simple vector
test_θ = rand(ne(instance.graph)) # This should match the number of edges
println("Test theta length: ", length(test_θ))

try
    test_solution = oracle(test_θ)
    println("Oracle output shape: ", size(test_solution))
    println("Oracle output length: ", length(test_solution))
catch e
    println("Oracle error: ", e)
end

model = Chain(Dense(size(features, 2) => 1), x -> relu.(x))
θ = model(features')
θ_vec = vec(θ')
loss(θ_vec, target_solution)

θ_error = Float32[
    102.14395,
    91.868034,
    76.5184,
    63.584602,
    54.741226,
    51.912994,
    51.00924,
    50.55326,
    106.76409,
    100.61224,
    100.61224,
    95.8254,
    95.8254,
    95.8254,
    85.04829,
    85.04829,
    78.97581,
    78.97581,
    75.842636,
    75.842636,
    73.44157,
    73.44157,
    68.04105,
    68.04105,
    68.04105,
    65.589806,
    65.708145,
    63.41192,
    63.41192,
    55.946198,
    55.946198,
    51.818947,
    51.818947,
    51.489105,
    51.489105,
    46.34768,
    46.34768,
    45.682434,
    45.682434,
    45.28563,
    45.28563,
    45.64425,
    45.64425,
    43.12841,
    43.12841,
    43.12841,
    43.840805,
    43.840805,
    45.08719,
    45.08719,
    43.36325,
    43.36325,
    41.75863,
    41.87696,
    41.435013,
    41.553352,
    42.005196,
    42.005196,
    44.1232,
    44.1232,
    49.055298,
    49.055298,
    102.199234,
    102.199234,
    95.44948,
    95.44948,
    95.44948,
    91.52277,
    91.52277,
    91.52277,
    81.93742,
    81.93742,
    74.4823,
    74.4823,
    74.4823,
    73.41984,
    73.41984,
    73.41984,
    66.39653,
    66.39653,
    61.06839,
    61.18673,
    61.18673,
    57.771454,
    57.771454,
    57.771454,
    50.178345,
    50.178345,
    44.50357,
    44.50357,
    44.50357,
    43.898247,
    43.898247,
    43.898247,
    44.49887,
    44.617203,
    41.575867,
    41.457535,
    41.575867,
    40.85488,
    40.85488,
    40.85488,
    42.12349,
    42.12349,
    42.12349,
    41.528687,
    41.528687,
    39.529556,
    39.529556,
    39.529556,
    40.47165,
    40.47165,
    40.47165,
    37.77542,
    37.77542,
    34.850998,
    34.850998,
    34.850998,
    33.187447,
    33.30578,
    33.30578,
    36.232727,
    36.351067,
    35.626244,
    35.507904,
    35.626244,
    37.15972,
    37.15972,
    37.15972,
    42.552315,
    42.552315,
    42.552315,
    106.895454,
    99.06611,
    99.06611,
    99.06611,
    93.179474,
    93.179474,
    93.179474,
    87.69314,
    87.69314,
    87.69314,
    79.57408,
    79.57408,
    71.211945,
    71.211945,
    71.211945,
    71.714165,
    71.714165,
    71.714165,
    64.87594,
    64.87594,
    58.4386,
    58.55694,
    58.55694,
    51.870026,
    51.751686,
    51.870026,
    50.602074,
    50.602074,
    45.86303,
    45.86303,
    45.86303,
    40.628914,
    40.628914,
    40.628914,
    42.4218,
    42.30346,
    42.4218,
    44.242317,
    44.242317,
    42.593826,
    42.593826,
    42.593826,
    43.058228,
    43.058228,
    43.058228,
    40.339653,
    40.339653,
    38.01243,
    38.01243,
    38.01243,
    37.101845,
    37.101845,
    37.101845,
    36.255714,
    36.255714,
    33.64631,
    33.527977,
    33.64631,
    31.803783,
    31.685448,
    31.803783,
    30.34191,
    30.223574,
    30.34191,
    36.087776,
    36.087776,
    34.29341,
    34.29341,
    34.29341,
    40.244026,
    40.244026,
    40.244026,
    84.93531,
    84.93531,
    69.34351,
    69.34351,
    50.775223,
    50.893555,
    39.475655,
    39.475655,
    28.388178,
    28.506514,
    32.46241,
    32.46241,
    93.64576,
    86.39055,
    86.39055,
    79.08845,
    79.08845,
    79.08845,
    76.14907,
    76.14907,
    69.83815,
    69.83815,
    63.051018,
    63.051018,
    63.051018,
    63.348503,
    63.348503,
    56.257507,
    51.10182,
    51.10182,
    45.41086,
    45.52919,
    45.52919,
    44.41835,
    44.53669,
    39.582664,
    39.701004,
    33.754845,
    33.754845,
    33.754845,
    33.96879,
    33.96879,
    33.561226,
    33.699135,
    30.80798,
    30.945889,
    28.844732,
    28.963068,
    30.148691,
    30.267027,
    31.57436,
    29.57017,
    29.57017,
    29.527878,
    29.527878,
    26.88086,
    24.912046,
    24.912046,
    24.089754,
    24.20809,
    24.20809,
    28.368015,
    26.825787,
    26.825787,
    26.825787,
    30.906168,
    31.024504,
    100.62657,
    91.624794,
    91.624794,
    91.624794,
    85.3079,
    85.3079,
    85.3079,
    80.876175,
    80.876175,
    80.876175,
    67.414696,
    67.414696,
    59.6018,
    59.6018,
    59.6018,
    57.9628,
    57.9628,
    57.9628,
    57.100372,
    57.100372,
    52.087433,
    52.087433,
    52.087433,
    48.393517,
    48.393517,
    48.393517,
    46.13875,
    46.13875,
    46.13875,
    39.120964,
    39.239304,
    33.06221,
    32.94388,
    33.06221,
    34.275414,
    34.275414,
    34.275414,
    29.053514,
    29.053514,
    24.436836,
    24.436836,
    24.436836,
    25.81888,
    25.937216,
    25.937216,
    25.785234,
    25.785234,
    23.308743,
    23.308743,
    23.308743,
    23.517368,
    23.517368,
    23.517368,
    21.632513,
    21.632513,
    19.83698,
    19.83698,
    19.83698,
    19.37133,
    19.489666,
    19.489666,
    22.680794,
    22.79913,
    21.848557,
    21.73022,
    21.848557,
    22.445093,
    22.326757,
    22.445093,
    25.940691,
    25.940691,
    25.940691,
    93.70878,
    93.70878,
    87.41883,
    87.41883,
    87.41883,
    82.94222,
    82.94222,
    82.94222,
    67.41865,
    67.41865,
    58.980217,
    58.980217,
    58.980217,
    59.138855,
    59.138855,
    59.138855,
    55.669975,
    55.669975,
    51.462418,
    51.462418,
    51.462418,
    48.949112,
    48.949112,
    48.949112,
    39.323265,
    39.323265,
    32.26152,
    32.379852,
    32.379852,
    34.536545,
    34.536545,
    34.536545,
    27.756937,
    27.756937,
    21.605259,
    21.605259,
    21.605259,
    22.55994,
    22.678276,
    22.678276,
    22.944078,
    23.062414,
    21.102373,
    20.984037,
    21.102373,
    19.821798,
    19.703463,
    19.821798,
    18.521687,
    18.40335,
    18.521687,
    18.202784,
    18.202784,
    18.619173,
    18.619173,
    18.737509,
    20.254154,
    20.135818,
    20.254154,
    23.844896,
    23.844896,
    23.561087,
    23.561087,
    23.561087,
    25.08917,
    25.08917,
    25.08917,
    59.310005,
    59.310005,
    32.21453,
    32.332863,
    21.7321,
    21.7321,
    16.074757,
    16.193092,
    15.378836,
    15.497171,
    23.879625,
    23.879625,
    95.01666,
    87.12671,
    87.12671,
    81.31374,
    81.31374,
    76.74019,
    76.74019,
    62.354813,
    55.220413,
    55.220413,
    55.220413,
    54.14704,
    54.14704,
    52.2452,
    52.2452,
    47.29418,
    47.29418,
    45.727203,
    45.727203,
    45.01892,
    45.01892,
    34.933212,
    27.899984,
    28.01832,
    28.01832,
    26.944323,
    27.062658,
    25.653023,
    25.771358,
    21.673214,
    21.79155,
    17.392488,
    17.274153,
    17.392488,
    19.83754,
    19.83754,
    17.954325,
    13.458032,
    13.458032,
    10.16751,
    10.305419,
    10.305419,
    11.853959,
    11.991868,
    9.207317,
    9.207317,
    9.325653,
    11.297932,
    11.297932,
    13.119841,
    13.119841,
    17.87005,
    18.084644,
    18.084644,
    19.380772,
    19.380772,
    19.380772,
    83.774574,
    83.774574,
    76.29329,
    76.29329,
    76.29329,
    70.68492,
    70.68492,
    70.68492,
    66.611015,
    66.611015,
    58.372528,
    58.372528,
    58.372528,
    54.44146,
    54.44146,
    54.44146,
    54.004646,
    54.004646,
    54.004646,
    44.763046,
    44.763046,
    41.88324,
    41.88324,
    41.88324,
    41.21998,
    41.33831,
    41.33831,
    33.56227,
    33.56227,
    28.28724,
    28.28724,
    28.28724,
    27.915817,
    27.915817,
    27.915817,
    20.911917,
    20.911917,
    15.325412,
    15.4437475,
    15.4437475,
    16.816673,
    16.816673,
    16.816673,
    14.358183,
    14.358183,
    10.102121,
    10.102121,
    10.102121,
    10.49187,
    10.610206,
    10.610206,
    10.523709,
    10.523709,
    8.99429,
    8.99429,
    8.99429,
    8.506339,
    8.506339,
    8.506339,
    12.405819,
    12.405819,
    11.924895,
    11.924895,
    11.924895,
    13.072664,
    13.072664,
    13.072664,
    15.661667,
    15.661667,
    15.661667,
    85.52534,
    85.52534,
    78.8276,
    78.8276,
    78.8276,
    74.07392,
    74.07392,
    74.07392,
    58.57965,
    58.57965,
    55.647522,
    55.647522,
    55.647522,
    55.41297,
    55.41297,
    55.41297,
    41.99315,
    41.99315,
    40.15811,
    40.15811,
    40.15811,
    38.110283,
    38.228615,
    38.228615,
    36.615997,
    36.615997,
    32.822357,
    32.822357,
    32.822357,
    29.868332,
    29.868332,
    29.868332,
    29.37962,
    29.37962,
    29.37962,
    20.434052,
    20.434052,
    13.547992,
    13.666327,
    13.666327,
    14.19409,
    14.19409,
    14.19409,
    13.946515,
    13.946515,
    11.006827,
    11.006827,
    11.006827,
    7.4126234,
    7.530959,
    7.530959,
    10.166451,
    10.166451,
    10.166451,
    12.281266,
    12.281266,
    10.040883,
    10.040883,
    10.040883,
    8.914638,
    8.914638,
    8.914638,
    14.912336,
    14.912336,
    14.948824,
    14.830488,
    14.948824,
    15.063783,
    14.945447,
    15.063783,
    58.23002,
    58.23002,
    41.356476,
    41.474815,
    14.522482,
    14.640818,
    8.115264,
    8.2336,
    8.941996,
    8.941996,
    15.908152,
    15.908152,
    87.061844,
    80.65226,
    80.65226,
    79.28821,
    79.28821,
    55.425117,
    55.425117,
    50.249603,
    50.249603,
    47.06356,
    47.06356,
    44.307327,
    44.307327,
    37.04679,
    37.165123,
    37.165123,
    35.733498,
    35.851837,
    33.951324,
    34.069664,
    31.932825,
    28.428429,
    28.428429,
    26.56637,
    26.56637,
    17.469112,
    10.784272,
    10.902608,
    10.902608,
    11.170152,
    11.327634,
    10.934987,
    11.053323,
    7.9406624,
    8.058998,
    4.3712134,
    4.3712134,
    4.489549,
    9.526851,
    9.526851,
    14.941999,
    10.086196,
    10.086196,
    6.50879,
    6.50879,
    6.50879,
    12.556096,
    12.921924,
    12.921924,
    14.039887,
    14.039887,
    14.039887,
    83.55589,
    83.55589,
    76.36011,
    76.36011,
    76.36011,
    75.82875,
    75.82875,
    75.82875,
    55.631325,
    55.631325,
    48.91857,
    48.91857,
    48.91857,
    47.48324,
    47.48324,
    47.48324,
    38.006775,
    38.006775,
    33.269745,
    33.269745,
    33.269745,
    29.425154,
    29.54349,
    29.54349,
    29.435528,
    29.553864,
    25.444616,
    25.32628,
    25.444616,
    22.442924,
    22.324589,
    22.442924,
    19.949966,
    19.949966,
    20.068302,
    18.745832,
    18.982508,
    13.746472,
    13.509797,
    13.746472,
    9.142915,
    9.142915,
    9.2612505,
    11.637353,
    11.637353,
    11.637353,
    8.524459,
    8.524459,
    3.8244371,
    3.9427729,
    3.9427729,
    7.9764166,
    7.9764166,
    7.9764166,
    12.267767,
    12.267767,
    7.06397,
    7.06397,
    7.06397,
    3.3390021,
    3.3390021,
    3.3390021,
    7.6811547,
    7.7994905,
    7.6707244,
    7.5523887,
    7.6707244,
    8.841357,
    8.7230215,
    8.841357,
    12.457462,
    12.457462,
    12.457462,
    89.776306,
    81.42553,
    81.42553,
    81.42553,
    74.09651,
    74.09651,
    74.09651,
    74.441696,
    74.441696,
    74.441696,
    56.637825,
    56.637825,
    49.07331,
    49.07331,
    49.07331,
    48.624786,
    48.624786,
    48.624786,
    40.692116,
    40.692116,
    35.589615,
    35.589615,
    35.589615,
    31.151306,
    31.269642,
    31.269642,
    30.155876,
    30.155876,
    26.714079,
    26.714079,
    26.714079,
    24.91565,
    24.91565,
    24.91565,
    16.531008,
    16.649343,
    10.450725,
    10.450725,
    10.56906,
    13.466468,
    13.466468,
    13.466468,
    9.415926,
    9.415926,
    3.456065,
    3.5744007,
    3.5744007,
    8.257083,
    8.257083,
    8.257083,
    12.456755,
    12.456755,
    7.9695196,
    8.087855,
    8.087855,
    4.512951,
    4.394615,
    4.512951,
    11.921636,
    11.921636,
    12.52516,
    12.52516,
    12.52516,
    13.198939,
    13.198939,
    13.198939,
    73.924644,
    73.924644,
    50.61863,
    50.61863,
    32.37568,
    32.49401,
    12.665989,
    12.902664,
    4.4339504,
    4.552286,
    4.7033935,
    4.821729,
    14.4085045,
    14.4085045,
    86.580536,
    77.79071,
    77.79071,
    69.88724,
    69.88724,
    69.88724,
    68.309685,
    68.309685,
    55.850594,
    48.144836,
    48.144836,
    48.144836,
    47.139984,
    47.139984,
    38.84458,
    34.92295,
    34.92295,
    31.545471,
    31.663809,
    31.663809,
    38.7763,
    33.638138,
    33.638138,
    30.84489,
    30.84489,
    18.036552,
    10.651821,
    10.888496,
    10.888496,
    10.026932,
    10.263607,
    8.619834,
    8.856509,
    4.836266,
    5.0729413,
    0.5514346,
    0.5514346,
    0.6697703,
    3.456607,
    3.6932824,
    5.4374437,
    3.4022627,
    3.4022627,
    2.3236198,
    2.3236198,
    2.4419556,
    10.331812,
    11.523252,
    11.523252,
    13.549903,
    13.549903,
    13.549903,
    76.1694,
    76.1694,
    67.69995,
    67.69995,
    67.69995,
    65.02695,
    65.02695,
    65.02695,
    53.125374,
    53.125374,
    46.129623,
    46.129623,
    46.129623,
    42.858994,
    42.858994,
    42.858994,
    41.15808,
    41.15808,
    34.74373,
    34.74373,
    34.74373,
    32.496155,
    32.496155,
    32.496155,
    31.477812,
    31.596148,
    31.596148,
    35.75669,
    35.75669,
    29.842377,
    29.842377,
    29.842377,
    26.00399,
    26.00399,
    26.00399,
    24.12397,
    24.12397,
    18.15175,
    18.15175,
    18.15175,
    13.442064,
    13.442064,
    13.442064,
    13.370252,
    13.370252,
    13.370252,
    5.467378,
    5.585714,
    0.13441455,
    0.01607886,
    0.13441455,
    0.7648445,
    0.88318396,
    1.0015197,
    2.5251515,
    2.8801625,
    0.40468633,
    0.049675345,
    0.40468633,
    0.0,
    0.0,
    0.0,
    0.0,
    0.0,
    0.0,
    5.2211804,
    5.2211804,
    6.2633862,
    6.2633862,
    6.2633862,
    8.760173,
    8.760173,
    8.760173,
    12.7815275,
    12.7815275,
    12.7815275,
    75.6215,
    75.6215,
    65.91707,
    65.91707,
    65.91707,
    62.85997,
    62.85997,
    62.85997,
    59.573257,
    59.573257,
    54.044426,
    54.044426,
    54.044426,
    49.05053,
    49.05053,
    49.05053,
    47.021507,
    47.021507,
    47.021507,
    36.42737,
    36.42737,
    34.748764,
    34.748764,
    34.748764,
    33.617714,
    33.736046,
    33.736046,
    38.592957,
    38.592957,
    33.661278,
    33.661278,
    33.661278,
    30.778566,
    30.778566,
    30.778566,
    23.685635,
    23.685635,
    18.981054,
    18.981054,
    18.981054,
    18.241909,
    18.241909,
    18.241909,
    8.70346,
    8.70346,
    2.679918,
    2.679918,
    2.679918,
    5.279548,
    5.279548,
    5.279548,
    4.833006,
    5.069681,
    3.9397426,
    3.8214068,
    3.9397426,
    3.2099404,
    3.2099404,
    3.3282762,
    11.306203,
    11.306203,
    12.833091,
    12.833091,
    12.833091,
    15.071501,
    15.071501,
    15.071501,
    68.66967,
    68.66967,
    37.385956,
    37.504288,
    6.3914533,
    6.3914533,
    6.091513,
    6.3281884,
    18.261936,
    18.261936,
    75.620964,
    67.34137,
    67.34137,
    67.34137,
    66.418945,
    66.418945,
    57.77024,
    51.874817,
    51.874817,
    47.25917,
    47.25917,
    43.280624,
    43.280624,
    35.630936,
    35.749275,
    35.749275,
    34.433594,
    34.551926,
    33.206467,
    33.324806,
    32.991386,
    29.623291,
    29.623291,
    27.888348,
    27.888348,
    21.579931,
    18.911467,
    18.911467,
    16.535307,
    16.535307,
    14.496717,
    14.496717,
    10.348098,
    10.348098,
    5.9085307,
    5.9085307,
    5.9085307,
    8.556586,
    8.556586,
    14.207765,
    10.108925,
    10.108925,
    6.893686,
    7.1303616,
    7.1303616,
    16.018131,
    16.577414,
    16.577414,
    18.871248,
    18.871248,
    18.871248,
    74.84073,
    74.84073,
    67.42069,
    67.42069,
    67.42069,
    64.13252,
    64.13252,
    64.13252,
    62.137787,
    62.137787,
    56.23806,
    56.23806,
    56.23806,
    51.698746,
    51.698746,
    51.698746,
    49.177452,
    49.29579,
    49.29579,
    39.06575,
    39.06575,
    34.90017,
    34.90017,
    34.90017,
    33.400925,
    33.400925,
    33.400925,
    30.166834,
    30.166834,
    26.191828,
    26.191828,
    26.191828,
    23.632946,
    23.632946,
    23.632946,
    23.609814,
    23.609814,
    19.550556,
    19.550556,
    19.550556,
    18.487581,
    18.487581,
    18.487581,
    18.42422,
    18.42422,
    18.42422,
    13.945391,
    13.945391,
    8.770101,
    8.770101,
    8.770101,
    10.020375,
    10.020375,
    10.020375,
    15.207119,
    15.207119,
    10.60847,
    10.60847,
    10.60847,
    8.427113,
    8.663788,
    8.663788,
    15.293329,
    15.293329,
    16.42259,
    16.42259,
    16.42259,
    20.582975,
    20.582975,
    20.582975,
    86.25592,
    75.84149,
    75.84149,
    75.84149,
    71.44548,
    71.44548,
    71.44548,
    68.91913,
    68.91913,
    68.91913,
    61.44496,
    61.5633,
    56.913124,
    56.913124,
    56.913124,
    54.280716,
    54.280716,
    54.280716,
    42.494377,
    42.494377,
    37.82489,
    37.82489,
    37.82489,
    33.331207,
    33.331207,
    33.331207,
    33.70401,
    33.70401,
    30.890125,
    30.890125,
    30.890125,
    28.617916,
    28.617916,
    28.617916,
    26.226818,
    26.226818,
    26.226818,
    23.390522,
    23.390522,
    23.109041,
    23.109041,
    23.109041,
    23.151867,
    23.151867,
    23.151867,
    18.273502,
    18.273502,
    13.138945,
    13.138945,
    13.138945,
    12.086277,
    12.086277,
    12.086277,
    17.584078,
    17.584078,
    13.104838,
    13.104838,
    13.104838,
    8.757671,
    8.994347,
    8.994347,
    13.584697,
    13.821372,
    15.518413,
    15.400073,
    15.636748,
    17.135666,
    17.01733,
    17.135666,
    23.645334,
    23.645334,
    23.645334,
    80.0429,
    80.0429,
    38.709686,
    38.709686,
    30.407635,
    30.407635,
    26.987164,
    26.987164,
    14.745721,
    14.745721,
    13.451836,
    13.570171,
    23.094688,
    23.213024,
    81.183815,
    81.183815,
    77.60239,
    77.60239,
    74.842476,
    74.842476,
    71.93408,
    69.06925,
    69.06925,
    68.445335,
    68.445335,
    51.85266,
    45.03907,
    45.03907,
    40.78203,
    40.78203,
    40.78203,
    40.88981,
    36.061424,
    36.061424,
    32.44915,
    32.44915,
    32.44915,
    28.224169,
    28.224169,
    27.472921,
    27.472921,
    27.897045,
    27.897045,
    22.319027,
    18.41631,
    18.41631,
    14.190114,
    14.190114,
    14.190114,
    16.475693,
    16.594028,
    15.445751,
    15.564088,
    14.459414,
    14.616896,
    15.325193,
    15.443529,
    15.443529,
    28.228052,
    25.375252,
    25.493587,
    25.493587,
    31.51027,
    31.51027,
    92.66464,
    82.41251,
    82.41251,
    82.41251,
    77.87586,
    77.87586,
    77.87586,
    74.08995,
    74.08995,
    74.08995,
    74.00876,
    74.00876,
    70.157814,
    70.157814,
    70.157814,
    68.151054,
    68.151054,
    68.151054,
    68.34081,
    68.34081,
    68.34081,
    53.22052,
    53.22052,
    46.258957,
    46.258957,
    46.258957,
    43.446854,
    43.446854,
    43.446854,
    41.048912,
    41.048912,
    37.277336,
    37.277336,
    37.277336,
    34.906403,
    34.906403,
    34.906403,
    30.094488,
    30.094488,
    27.149357,
    27.149357,
    27.149357,
    26.224442,
    26.106106,
    26.224442,
    26.368544,
    26.48688,
    22.271667,
    22.271667,
    22.390003,
    19.82303,
    19.704695,
    19.82303,
    18.572336,
    18.454,
    18.572336,
    20.707666,
    20.707666,
    19.144575,
    19.144575,
    19.144575,
    20.244516,
    20.244516,
    20.244516,
    31.155441,
    31.155441,
    28.827578,
    28.945913,
    28.945913,
    33.36367,
    33.36367,
    33.36367,
    87.952675,
    87.952675,
    82.477684,
    82.477684,
    82.477684,
    78.00859,
    78.00859,
    78.00859,
    76.76251,
    76.76251,
    73.958176,
    73.958176,
    73.958176,
    73.32034,
    73.32034,
    73.32034,
    56.93438,
    56.93438,
    49.04281,
    49.04281,
    49.04281,
    46.279694,
    46.279694,
    46.279694,
    45.5262,
    45.5262,
    42.384117,
    42.384117,
    42.384117,
    39.851845,
    39.851845,
    39.851845,
    37.33989,
    37.33989,
    37.33989,
    36.259247,
    36.259247,
    32.557526,
    32.675858,
    32.675858,
    30.026588,
    30.026588,
    30.026588,
    31.55464,
    31.55464,
    31.55464,
    29.746368,
    29.746368,
    26.51246,
    26.51246,
    26.51246,
    23.919128,
    23.919128,
    23.919128,
    27.23884,
    27.23884,
    25.723888,
    25.723888,
    25.723888,
    25.463009,
    25.463009,
    25.463009,
    36.053,
    36.053,
    34.33584,
    34.454178,
    34.454178,
    37.259827,
    37.141495,
    37.259827,
    81.80323,
    81.80323,
    55.293304,
    55.293304,
    36.770004,
    36.770004,
    29.872774,
    29.872774,
    30.969385,
    30.969385,
    41.88923,
    42.00757,
    103.08413,
    95.16056,
    95.16056,
    89.16846,
    89.16846,
    83.51639,
    83.51639,
    83.51639,
    80.093956,
    75.77397,
    75.77397,
    73.18184,
    73.18184,
    63.360184,
    57.49404,
    57.49404,
    57.49404,
    59.839966,
    59.839966,
    63.880455,
    59.54413,
    59.54413,
    57.45372,
    57.45372,
    45.776215,
    39.440475,
    39.440475,
    39.440475,
    41.925003,
    41.925003,
    40.371582,
    36.825058,
    36.825058,
    33.588684,
    33.588684,
    33.588684,
    37.925957,
    35.59365,
    35.59365,
    34.304245,
    34.304245,
    34.304245,
    41.6455,
    42.568,
    42.568,
    44.22209,
    44.340424,
    44.340424,
    97.45365,
    97.45365,
    90.33493,
    90.33493,
    90.33493,
    85.02531,
    85.02531,
    85.02531,
    83.69045,
    83.69045,
    78.45148,
    78.45148,
    78.45148,
    74.665764,
    74.665764,
    74.665764,
    71.62544,
    71.62544,
    71.62544,
    70.13246,
    70.13246,
    64.84065,
    64.84065,
    64.84065,
    61.089523,
    61.089523,
    61.089523,
    62.930565,
    62.930565,
    62.930565,
    64.78578,
    64.78578,
    59.779892,
    59.779892,
    59.779892,
    57.89324,
    57.89324,
    57.89324,
    48.86091,
    48.86091,
    43.54081,
    43.54081,
    43.54081,
    45.012657,
    45.012657,
    45.012657,
    42.416756,
    42.416756,
    39.140236,
    39.140236,
    39.140236,
    38.32772,
    38.32772,
    38.32772,
    39.49623,
    39.49623,
    37.813904,
    37.813904,
    37.813904,
    38.28267,
    38.28267,
    38.28267,
    43.890892,
    43.890892,
    44.78115,
    44.78115,
    44.78115,
    47.75216,
    47.75216,
    47.75216,
    102.92816,
    102.92816,
    96.32691,
    96.32691,
    96.32691,
    92.50027,
    92.50027,
    92.50027,
    85.89792,
    85.89792,
    81.280556,
    81.280556,
    81.280556,
    79.196625,
    79.196625,
    79.196625,
    72.596924,
    72.596924,
    68.08051,
    68.08051,
    68.08051,
    69.31173,
    69.31173,
    69.31173,
    67.91948,
    67.91948,
    62.709106,
    62.709106,
    62.709106,
    59.483215,
    59.483215,
    59.483215,
    57.34443,
    57.34443,
    52.72631,
    52.72631,
    52.72631,
    48.72043,
    48.72043,
    48.72043,
    47.97992,
    47.97992,
    47.97992,
    47.839554,
    47.839554,
    45.23854,
    45.23854,
    45.23854,
    43.313385,
    43.313385,
    43.313385,
    42.129868,
    42.129868,
    42.129868,
    43.291267,
    43.291267,
    42.195877,
    42.195877,
    42.195877,
    41.86129,
    41.86129,
    41.86129,
    42.490852,
    42.490852,
    42.490852,
    45.734787,
    45.734787,
    46.73709,
    46.73709,
    46.73709,
    48.93284,
    48.93284,
    48.93284,
    52.48767,
    52.48767,
    52.48767,
]
y_target = sparsevec(
    [
        168,
        251,
        261,
        264,
        280,
        312,
        315,
        355,
        358,
        390,
        393,
        424,
        426,
        432,
        452,
        470,
        473,
        483,
        537,
        545,
        553,
        615,
        618,
        722,
        725,
        728,
        733,
        736,
        741,
        752,
        778,
        781,
        794,
        855,
        878,
        892,
        895,
        900,
        903,
        905,
        908,
        911,
        954,
        963,
        990,
        1049,
        1051,
    ],
    [
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        2.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        2.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        2.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        2.0,
        1.0,
        1.0,
        1.0,
        1.0,
        1.0,
    ],
    1646,
)
loss(θ_error, y_target)